---
title: "Tarea 1"
author:
- José Ignacio Rojas Zárate, C16911
- Montserrat Beirute Abarca, C10997
- Valeria Vásquez Venegas, C18373
date: "`r format(Sys.Date(), '%d de %B de %Y', locale = 'es_ES')`"
output:
  pdf_document:
    toc: yes
    latex_engine: xelatex
    number_sections: true
    keep_tex: true
  html_document:
    theme: spacelab
    highlight: arrow
    toc: yes
    toc_float: yes
    lang: es-ES
subtitle: Estadística Actuarial II
header-includes:
  - \usepackage[spanish]{babel}
  - \usepackage{fontspec}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

El presente documento prestan el código y resultados a los ejercicios de la Tarea 1 del curso. Para su realización, se utilizó el programa R studio. 

El presente trabajo utilizó la base de datos "BaseSalarios" brindada por el profesor Esteban Bermúdez Aguilar. 

La base de datos tiene 5 columnas. A continuación, se presentan los primeros seis registros de la base de datos "BaseSalarios" para poder explicar la información de cada columna. 

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
#---Paquetes---------------------------------------------------------

library(stringr) # para cambiar todas las commas a puntos en la columna Ultimo Salario
library(ggplot2) # para hacer los gráficos
library(univariateML) # para hacer el análisis AIC
library(rriskDistributions) # para hacer el análisis AIC
library(boot) # para hacer el bootstrap
library(ks) # para Kernel smoothing
library(knitr) # para presentar mejor los datos en formato tabla
options(scipen = 999) # para que no me salga notacion cientifica
library(cowplot) # para hacer graficos más atractivos
#---CSV y formatos----------------------------------------------------

# Abrir y dar formato a la base de datos

base_salarios <- read.csv("BaseSalarios.csv",  sep = ";")

base_salarios$Fec.Nac <- as.Date(base_salarios$Fec.Nac, format = "%d/%m/%Y")

colnames(base_salarios)[5] ="Ultimo.Salario"

base_salarios <- subset(base_salarios, select = -X)

base_salarios$Ultimo.Salario <- as.numeric(str_replace_all(base_salarios$Ultimo.Salario, ",", "."))

base_salarios_temp <- base_salarios
base_salarios_temp$Ultimo.Salario <- format(base_salarios$Ultimo.Salario, big.mark = " ")

base_salarios_temp2 <- base_salarios


```

```{r, echo=FALSE}
kable(head(base_salarios_temp), caption = "Primeros 6 registros de la base de datos", align = "r") 
```

La columna **ID** cuenta el número de registros disponibles, en este caso, se dispone de 106,002 registros. En la columna **Fec.Nac** se encuentra la información de la fecha de nacimiento de cada persona. En la tercera columna, **Sexo**, se observan los números 1 y 2; específicamente, si el valor de Sexo es 1, corresponde a hombres, y si es 2, corresponde a mujeres. La cuarta columna, **Cuotas** indica la cantidad de cuotas que cada persona ha aportado a un fondo de pensiones. Finalmente, la columna **Ultimo.Salario** contiene el último salario reportado, expresado en colones.  

# Parte I

##  Análisis descriptivo de las variables Cuotas y Salarios con respecto a la variable Sexo

De las 106,002 personas que contiene la base de datos utilizada, el 69.1% son mujeres (73,279 mujeres). Por su parte, el 30.1% restante corresponde a hombres (32,723 hombres).

Es de interés conocer las diferencias o similitudes en los datos del número de cuotas y los salarios según el sexo. 

A continuación, se presenta un cuadro con un resumen estadístico de los datos del número de cuotas para hombres y mujeres.

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

resumen_cuotas_hombres <-summary(base_salarios$Coutas[base_salarios$Sexo == 1])

varianza_cuotas_hombres <- var(base_salarios$Coutas[base_salarios$Sexo == 1])

resumen_cuotas_hombres <- c(resumen_cuotas_hombres, Varianza = varianza_cuotas_hombres)

resumen_cuotas_mujeres <-summary(base_salarios$Coutas[base_salarios$Sexo == 2])

varianza_cuotas_mujeres <- var(base_salarios$Coutas[base_salarios$Sexo == 2])

resumen_cuotas_mujeres <- c(resumen_cuotas_mujeres, Varianza = varianza_cuotas_mujeres)

cuotas_resumen <- data.frame(
  Estadistico = c("Mínimo", "Primer cuartil (Q1)", "Mediana", "Promedio", "Tercer cuartil (Q3)", "Máximo", "Varianza"),
  Hombres = as.numeric(round(resumen_cuotas_hombres,2)),
  Mujeres = as.numeric(round(resumen_cuotas_mujeres,2))
)

```

```{r, echo=FALSE}
kable(cuotas_resumen, caption = "Resumen estadístico de número de coutas por sexo")
```

Como se puede observar, tanto para mujeres como para hombres, el mínimo de cuotas aportadas es tan solo una.

Por su parte, se puede decir que en general las mujeres de la base de datos aportaron más cuotas que los hombres. 

Se puede notar que el 25% de los hombres aportó 61 cuotas o menos, mientras que en el caso de las mujeres, el 25% aportó 66 cuotas o menos.
 
Además, el 50% de las mujeres aportó más de 135 cuotas, mientras que en el caso de los hombres, fue de 124 cuotas.

El promedio de cuotas es más alto para las mujeres (142.97) que para los hombres (135.18). 

También, el 75% de las mujeres aportó 213 cuotas o menos, mientras que en el caso de los hombres, fue de 198 cuotas. 

El valor máximo de cuotas aportadas para las mujeres fue de 373, mientras que para los hombres fue de 371.

Es importante resaltar que para ambos sexos, la varianza indica que los datos están alejados de la media y se presenta mucha variabilidad en los datos de número de cuotas aportadas al fondo de pensiones. 


\newpage

Por otra parte, a continuación, se presenta un cuadro con un resumen estadístico de los datos del último salario reportado para hombres y mujeres.

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

resumen_salarios_hombres <-summary(base_salarios$Ultimo.Salario[base_salarios$Sexo == 1])

varianza_salarios_hombres <- var(base_salarios$Ultimo.Salario[base_salarios$Sexo == 1])

resumen_salarios_hombres <- c(resumen_salarios_hombres, Varianza = varianza_salarios_hombres)

resumen_salarios_mujeres <-summary(base_salarios$Ultimo.Salario[base_salarios$Sexo == 2])

varianza_salarios_mujeres <- var(base_salarios$Ultimo.Salario[base_salarios$Sexo == 2])

resumen_salarios_mujeres <- c(resumen_salarios_mujeres, Varianza = varianza_salarios_mujeres)

salarios_resumen <- data.frame(
  Estadistico = c("Mínimo", "Primer cuartil (Q1)", "Mediana", "Promedio", "Tercer cuartil (Q3)", "Máximo", "Varianza"),
  Hombres = format(as.numeric(round(resumen_salarios_hombres,2)),big.mark = " "),
  Mujeres = format(as.numeric(round(resumen_salarios_mujeres,2))
,big.mark = " "))

```

```{r, echo=FALSE}
kable(salarios_resumen, caption = "Resumen de Último Salario reportado por sexo", align = "r")
```

En el Cuadro 3, se observa que el salario más bajo reportado le pertenece a una mujer, siendo tan solo 656.93 colones menos que el salario más bajo de los hombres. 

En cuanto al Q1, se destaca que el 25% de los hombres tuvieron un último salario reportado de 552,498 colones o menos, mientras que el 25% de las mujeres tuvieron un último salario de 584,757 colones o menos. Es decir, en los últimos salarios más bajos, las mujeres experimentaron ingresos superiores a los de los hombres.

Ahora en relación a la mediana, la mitad de los hombres ganó más de 1,105,231 colones, mientras que la mitad de las mujeres ganó menos (1,046,661 colones). 

Además, el promedio de los últimos salarios fue mayor para los hombres, aproximadamente 110,540 colones más alto.

Las diferencias se incrementan a medida que se consideran los últimos salarios más altos. El 75% de las mujeres ganaron 1 403 025.79 o menos, mientras que el 75% de los hombres ganaron 1 611 786 colones o menos. 

El salario máximo reportado por hombres es 5 909 742 colones más alto que el de las mujeres. 

Es importante resaltar que la varianza para ambos sexos señala que los datos están muy dispersos de la media, es decir hay una gran variabilidad en los datos de último salario reportado. 

\newpage 

## Gráfico plotbox para el salario para comparar entre las categorías de Sexo

El siguiente gráfico plotbox permite tener una representación visual de como se distribuyen los datos para cada sexo. 

```{r, echo=FALSE}
base_salarios_temp2$Sexo <- factor(base_salarios$Sexo, levels = c(1, 2), labels = c("Hombre", "Mujer"))

boxplot_salarios <- ggplot(base_salarios_temp2, aes(x = Sexo, y = Ultimo.Salario, fill = Sexo)) +
  geom_boxplot() +
  theme_cowplot() +
  scale_x_discrete(labels = c("Hombre", "Mujer")) +
  scale_fill_manual(values = c("Hombre" = "lightblue", "Mujer" = "lightgreen")) +
  labs(x = "Sexo", y = "Ultimo salario reportado en miles de colones") +
  scale_y_continuous(breaks = seq(0, 15000000, by = 1000000), labels =   scales::comma_format(scale = 1e-3)) + ggtitle("Boxplot de Ultimo Salario por Sexo")

print(boxplot_salarios)
```

Este gráfico destaca la presencia de salarios atípicos, identificados como aquellos que están fuera de cada una de las cajas. Específicamente, en el caso de los hombres, se observan dos salarios que se encuentran notablemente por encima del resto de los salarios reportados, indicando la presencia de valores atípicos significativos. 

## Conclusiones con respecto a los salarios y sexo

Después de realizar el análisis descriptivo de los datos e interpretar la gráfica de Boxplot, se concluye que al dividir la población por sexo, el 25% de los hombres con los salarios más bajos ganan menos que el 25% de las mujeres con salarios más bajos. Sin embargo, cuando se considera el 50% de los hombres que ganan más, estos perciben un salario mayor que el 50% de las mujeres que ganan más. Esta tendencia se evidencia claramente en el gráfico anterior, donde la parte superior de la caja, que está por encima de la línea de la mediana, es más amplia en el caso de los hombres.


Para respaldar este argumento, se observa que el promedio de los últimos salarios fue mayor para los hombres, aproximadamente 110,540 colones más alto que el de las mujeres.

No obstante, es importante señalar que la varianza de los salarios es mayor para los hombres, y los valores atípicos en los salarios masculinos también son más altos que los de las mujeres.

En este sentido, los salarios de los hombres parecen ser relativamente más altos que los de las mujeres, aunque las diferencias no resultan significativas. Ambos tienen personas con salarios más altos que la mayoría. 


## Prueba de hipótesis sobre las medias de las categorías de sexo

En relación a las medias, se cree que las medias de los salarios para hombres y mujeres son diferentes.
Para verificar lo expresado anteriormente, se llevó a cabo la siguiente prueba de hipótesis. 

En este caso, se llevó a cabo un **Welch Two Sample t-test**, la cual es una prueba estadística que permite comparar las medias de dos muestras. En este caso, el tamaño de las muestras y sus varianzas difieren. 

Para realizar una prueba de hipótesis se necesitan tres cosas: la hipótesis nula (H0), el estadístico de prueba (t) y la distribución del estadístico de prueba. 

En este caso particular: 

1. H0: La diferencia entre la media de los últimos salarios de los hombres y la media de los últimos salarios de las mujeres es 0.
2. El estadístico de prueba es t, el cual se puede calcular de la siguiente manera: \[ t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}} \]
donde \( \bar{X}_1 \) y \( \bar{X}_2 \) son las medias de cada una de las muestras,
\( s_1 \) y \( s_2 \) son las desviaciones estándar de los dos muestras,
\( n_1 \) y \( n_2 \) son el tamaño de cada una de las muestras. 
3. Por último, el estadístico t sigue una distribución t con \( v \) grados de libertad, la cual se calcula utilizando la equación Welch–Satterthwaite.

A continuación se presenta el código de la prueba y la interpretación de los resultados:

```{r, results='markup'}
t.test(
  x           = base_salarios$Ultimo.Salario[base_salarios$Sexo == 1],
  y           = base_salarios$Ultimo.Salario[base_salarios$Sexo == 2],
  paired      = FALSE,
  alternative = "two.sided",
  conf.level  = 0.95
)
```

El p-valor lo que dice es si se asume la H0 como verdadera, la probabilidad de que H0 sea verdadera. En este caso, el valor p fue menor a \( 2.2e^{16} \) lo cual es muy cercano a 0, es decir, hay una probabilidad muy pequeña de que la media de los últimos salarios entre hombres y mujeres sea 0, es decir, que sea la misma. Por tanto, existe suficiente evidencia para rechazar la hipotesis nula. 


# Parte II

## Construcción del Histograma de los salarios

```{r, echo=FALSE}

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7) +
  labs(title = "Histograma de los últimos salarios reportados", x = "Salario en miles de colones", y = "Frecuencia") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )


```

## Densidad de los salarios por kernel (no paramétrica)

### Densidad de los salarios por kernel usando como kernel Biweigth 

```{r, echo=FALSE, warning=FALSE}

density_biweight <- density(base_salarios$Ultimo.Salario, kernel = "biweight")

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_biweight$x, y = density_biweight$y),
            aes(x, y), color = "cyan4", size = 1) +  
  labs(title = "Densidad de los últimos salarios reportados ", subtitle = "con Kernel Biweight", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )



```

### Densidad de los salarios por kernel usando como kernel Normal

```{r, echo=FALSE, warning=FALSE}

density_normal <- density(base_salarios$Ultimo.Salario,kernel = "gaussian")

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_normal$x, y = density_normal$y),
            aes(x, y), color = "red3", size = 1) +  
  labs(title = "Densidad de los últimos salarios reportados ", subtitle = "con Kernel Normal", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )

```


### Densidad de los salarios por kernel usando como kernel Epanechnikov

```{r, echo=FALSE, warning=FALSE}

density_epanechnikov <- density(base_salarios$Ultimo.Salario,kernel = "epanechnikov")

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_epanechnikov$x, y = density_epanechnikov$y),
            aes(x, y), color = "seagreen", size = 1) +  
  labs(title = "Densidad de los últimos salarios reportados ",subtitle = "con Kernel Epanechnikov", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )

```

### Densidad de los salarios por kernel usando como kernel Coseno

```{r, echo=FALSE, warning=FALSE}

density_coseno <- density(base_salarios$Ultimo.Salario,kernel = "cosine")

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_coseno$x, y = density_coseno$y),
            aes(x, y), color = "hotpink1", size = 1) +  
  labs(title = "Densidad de los últimos salarios reportados ",subtitle = "con Kernel Coseno", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )

```


### Densidad de los salarios por kernel usando como kernel Rectangular

```{r, echo=FALSE, warning=FALSE}

density_rectangular <- density(base_salarios$Ultimo.Salario,kernel = "rectangular")

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_rectangular$x, y = density_rectangular$y),
            aes(x, y), color = "goldenrod2", size = 1) +  
  labs(title = "Densidad de los últimos salarios reportados ",subtitle = "con Kernel Rectangular", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  )

```

### Densidad de los salarios con todos los kernel

```{r, echo=FALSE, warning=FALSE}

ggplot(base_salarios, aes(x = Ultimo.Salario)) +
  geom_histogram(binwidth = 150000, fill = "lightblue", color = "black", alpha = 0.7, aes(y = ..density..)) +
  geom_line(data = data.frame(x = density_normal$x, y = density_normal$y),
            aes(x, y, color = "Normal"), size = 1.5) +
  geom_line(data = data.frame(x = density_biweight$x, y = density_biweight$y),
            aes(x, y, color = "Biweight"), size = 1.4) +
  geom_line(data = data.frame(x = density_coseno$x, y = density_coseno$y),
            aes(x, y, color = "Coseno"), size = 1.3) +
  geom_line(data = data.frame(x = density_rectangular$x, y = density_rectangular$y),
            aes(x, y, color = "Rectangular"), size = 1.2) +
  geom_line(data = data.frame(x = density_epanechnikov$x, y = density_epanechnikov$y),
            aes(x, y, color = "Epanechnikov"), size = 1.1) +
  labs(title = "Densidad de los últimos salarios reportados", x = "Salario en miles de colones", y = "Densidad") +
  theme_cowplot() +
  scale_x_continuous(
    breaks = seq(min(base_salarios$Ultimo.Salario), max(base_salarios$Ultimo.Salario), length.out = 8),
    labels = scales::label_number(big.mark = " ", decimal.mark = ".", scale = 1e-3)
  ) +
  scale_color_manual(values = c("red3", "cyan4", "hotpink1", "goldenrod2", "seagreen"),
                     name = "Kernel",
                     labels = c("Normal", "Biweight", "Coseno", "Rectangular", "Epanechnikov")) +
  theme(legend.text = element_text(size = 6),
        legend.title = element_text(size = 9))



```

#Parte III

El Criterio de Información de Akaike (AIC) es una medida utilizada en estadísticas y modelado para comparar modelos estadísticos.El AIC se calcula utilizando la siguiente fórmula:

\[ AIC= 2*N−2*log(L) \]

Donde \[L\] representa la funcion de máxima verosimilitud del modelo y \[N\] representa el número de parámetros en el modelo. El modelo penaliza aquellos modelos que utilizan varios parámetros, ya que se busca el modelo con mayor simpleza. Cuando se comparan varios modelos, el modelo con el AIC más bajo se considera preferido.

##Análisis del AIC de la variable Ultimo.Salario mediante la función model_select
```{r, results='markup'}
model_select(base_salarios$Ultimo.Salario)
```

Vemos que la funcion model select del paquete univariateML sugiere una distribución t-student para representar los datos de Ultimo.Salario.

##Análisis del AIC de la variable Ultimo.Salario mediante la función fit.cont
```{r, results='markup'}
fit.cont(base_salarios$Ultimo.Salario)
```

Bajo el criterio de AIC el modelo con el valor mas bajo es el Weibull, seguido por el Logistic con una diferencia de 13 042 unidades. Mientras que la diferencia entre el Weibull y el Student es de 745 301 unidades. Es debido a ello que se escoge Weibull para representar nuestros datos de salarios.

##Construcción de un intervalo de confianza para la media y la desviación estándar usando la función bootstrapml
```{r, results='markup'}
#Creamos un objeto de distribución
distribucionml <- mlweibull(base_salarios$Ultimo.Salario)

bootstrapml(distribucionml, 
            map = function(x) mean(x))
bootstrapml(distribucionml, 
            map = function(x) sd(x))
```

